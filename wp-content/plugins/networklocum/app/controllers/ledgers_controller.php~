<?php
class LedgersController extends MvcPublicController {

	
	public function index() {
		$this->set('mylayout', 'client');	
  	}

	public function createledger() {
		global $wpdb;		
		$this->set('mylayout', 'client');
		//print_r($_POST);
		if(isset($_POST['save'])){
			$ledger_id = $_POST['ledger_id'];
			$ledgername = $_POST['ledgername'];
			$group_id = $_POST['group_id'];
			$opening_balance = $_POST['opening_balance'];
 			$p = "INSERT INTO wp_ledgers  (`ledgername`, `group_id`, `opening_balance`)
				 VALUES('$ledgername', '$group_id', '$opening_balance')";
		
			//echo $p;
			$wpdb->query($p);

			$this->flash('success', 'Successfully ledger Saved');
		}
     	}


	public function listledger(){
		$this->set('mylayout', 'client');
		$this->load_model('ledger');

  		$arrledgers =  $this->ledger->find(); 
		//echo "<pre>"; print_r($arrledgers);echo "</pre>";
		$this->set('ledgerData', $arrledgers);
		$this->load_model('ledger');
        	$params       = $this->params;
	      	$params['page']  = empty($this->params['page']) ? 1 : $this->params['page'];
         
		//print_r($_POST);
 		if( isset($_POST['Go'])  &&  isset($_POST['search_id'])  ) {
		//	print_r($_POST);

		$search_id = $_POST['search_id'];
		$search_data = $_POST['search_data'];

		if( $search_id == 'ledger_id' ){
  			$params['conditions'] = array('ledger.ledger_id' => $search_data);
 		}elseif($search_id == 'ledgername'){
			$params['conditions'] = array('ledger.ledgername LIKE ' => $search_data);
	 	}elseif($search_id == 'group_id'){
 			$params['conditions'] = array('ledger.group_id' => $search_data);
		}elseif($search_id == 'cheque_details'){
			$params['conditions'] = array('ledger.cheque_details' => $search_data);
 		}
		 
	 	 
	}
  

      
	// $params['joins']      = array('Ledger');
        //
	$params['includes']   = array('groupdata');
	$params['joins']      = array('groupdata');
        $params['selects']    = array('ledger.*','groupdata.groupname');		
	//$params['order']      = 'Requestadvicesession.id DESC';
	//print_r($params);	
	//$collection = $this->ledger->paginate($params);
	//echo "<pre>";	print_r($collection);
        //$this->set('ledgerData', $collection['objects']);
        $this->set_pagination($collection);
      


  	}




	public function viewledger(){
		$this->set('mylayout', 'empty');	
		$this->load_model('ledger');    
		 
		$arrParm = array( 
		                'selects'    => array('ledger.*'),
		                'conditions' => array('ledger.id' => $this->params['id'])
		           );

		$object = $this->ledger->find($arrParm);
		$this->set('ledgerData', $object);
 
 	}

	public function dashboard(){
	$this->set('mylayout', 'client');
	}

		

	public function editledger(){
		$this->set('mylayout', 'client');
		$oldrow = array();
		$led_id=$this->params['id'];
		global $wpdb;	
		 //print_r($_POST);
		if(isset($_POST['save'])){
			$ledger_id = $_POST['ledger_id'];
			$ledgername = $_POST['ledgername'];
			$group_id = $_POST['group_id'];
			$opening_balance = $_POST['opening_balance'];
			$p = "Update  wp_ledgers set ledgername='$ledgername', group_id='$group_id', opening_balance=$opening_balance Where id=$led_id";
   			//echo $p;
			$wpdb->query($p);

			$this->flash('success', 'Successfully ledger Saved');
		}


		if(isset($this->params['id']) ){
 	
			$led_id = $led_id=$this->params['id'];
			global $wpdb;	
   			$oldrow =  $wpdb->get_results("SELECT *  FROM wp_ledgers where id=".$led_id);
  		 }

	
		$this->set('oldrow', $oldrow[0]);
 	}

	public function deleteledger() {
		$this->set('mylayout', 'client');
 		
		$this->load_model('ledger');
		$this->ledger->delete($this->params['id']);
		$this->flash('notice', 'Successfully ledger deleted!');
		
		$url= esc_url( home_url( '/' ) ).'ledgers/listledger';
		$this->redirect($url);


			// print_r($_GET);
			 if(isset($_GET['action'])){
			 if( $_GET['action'] == "delete") {
			 $led_id = $_GET['led_id'];
			 $p = "Delete from ledger where ledger_id= $led_id";
			 //echo $p;
			mysql_query($p);
			}}
 	 }
}

?>	
